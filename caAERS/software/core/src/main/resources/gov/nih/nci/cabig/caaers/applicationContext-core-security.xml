<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd
http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.0.xsd" >
    <bean id="authorizationSwitch"
          class="gov.nih.nci.security.acegi.csm.authorization.AuthorizationSwitch"
          factory-method="getInstance">
        <property name="on" value="true"/>
    </bean>


    <bean id="csmApplicationContextName" class="java.lang.String">
        <constructor-arg value="caaers"/>
    </bean>


    <bean id="csmAuthorizationDao"
          class="gov.nih.nci.security.dao.DIAuthorizationDao"
          init-method="init">
        <property name="sessionFactory">
            <bean
                    class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
                <property name="dataSource" ref="dataSource"/>
                <property name="mappingResources">
                    <list>
                        <value>
                            gov/nih/nci/security/authorization/domainobjects/Privilege.hbm.xml
                        </value>
                        <value>
                            gov/nih/nci/security/authorization/domainobjects/Application.hbm.xml
                        </value>
                        <value>
                            gov/nih/nci/security/authorization/domainobjects/Role.hbm.xml
                        </value>
                        <value>
                            gov/nih/nci/security/dao/hibernate/RolePrivilege.hbm.xml
                        </value>
                        <value>
                            gov/nih/nci/security/dao/hibernate/UserGroup.hbm.xml
                        </value>
                        <value>
                            gov/nih/nci/security/dao/hibernate/ProtectionGroupProtectionElement.hbm.xml
                        </value>
                        <value>
                            gov/nih/nci/security/authorization/domainobjects/Group.hbm.xml
                        </value>
                        <value>
                            gov/nih/nci/security/authorization/domainobjects/User.hbm.xml
                        </value>
                        <value>
                            gov/nih/nci/security/authorization/domainobjects/ProtectionGroup.hbm.xml
                        </value>
                        <value>
                            gov/nih/nci/security/authorization/domainobjects/ProtectionElement.hbm.xml
                        </value>
                        <value>
                            gov/nih/nci/security/authorization/domainobjects/UserGroupRoleProtectionGroup.hbm.xml
                        </value>
                        <value>
                            gov/nih/nci/security/authorization/domainobjects/UserProtectionElement.hbm.xml
                        </value>
                    </list>
                </property>
                <property name="hibernateProperties">
                    <bean
                            class="gov.nih.nci.cabig.ctms.tools.spring.HibernatePropertiesFactoryBean">
                        <!--
                              <property name="dialectName">

                                  <value>s[hibernate.dialect]</value>

                              </property>
                                   -->
                        <property name="properties">
                            <props>
                                <!--
                                            <prop key="hibernate.show_sql">
                                            true
                                            </prop>
                                            <prop key="hibernate.format_sql">
                                            true
                                            </prop>
                                        -->
                                <prop
                                        key="hibernate.connection.release_mode">
                                    after_transaction
                                </prop>

                            </props>
                        </property>
                    </bean>
                </property>
            </bean>
        </property>
        <property name="applicationContextName"
                  ref="csmApplicationContextName"/>
    </bean>

    <bean id="csmUserProvisioningManager" class="gov.nih.nci.security.provisioning.UserProvisioningManagerImpl">
        <property name="authorizationDAO" ref="csmAuthorizationDao"/>
    </bean>
    

    <bean id="csmObjectIdGenerator"
          class="gov.nih.nci.security.acegi.csm.authorization.BasicCSMObjectIdGenerator">
        <property name="idMethodName" value="getId"/>
        <property name="classNameFirst" value="true"/>
        <property name="separator" value=":"/>
    </bean>

    <bean id="csmExtentIdGenerator"
          class="gov.nih.nci.security.acegi.csm.authorization.BasicCSMObjectIdGenerator"/>

    <aop:aspectj-autoproxy/>
    <aop:spring-configured/>

    <aop:config>
        <!-- pointcuts -->
        <aop:pointcut id="daoSaveOrUpdatePointcut"
                      expression="execution(public void gov.nih.nci.cabig.caaers.dao.CaaersDao+.save(gov.nih.nci.cabig.ctms.domain.AbstractMutableDomainObject+))
        || execution(public void gov.nih.nci.cabig.caaers.dao.CaaersDao+.merge(gov.nih.nci.cabig.ctms.domain.AbstractMutableDomainObject+))
        || execution(public * gov.nih.nci.cabig.caaers.dao.StudyDao+.search*(..))
        ||execution(public * gov.nih.nci.cabig.caaers.dao.StudyDao+.get*(..))
        ||execution(public * gov.nih.nci.cabig.caaers.domain.repository.ajax.StudySearchableAjaxableDomainObjectRepository+.find*(..))
        ||execution(public * gov.nih.nci.cabig.caaers.dao.StudyDao+.match*(..))
        ||execution(public * gov.nih.nci.cabig.caaers.domain.repository.ajax.ParticipantAjaxableDomainObjectRepository+.find*(..))
        ||execution(public * gov.nih.nci.cabig.caaers.dao.ExpeditedAdverseEventReportDao+.search*(..))
        ||execution(public * gov.nih.nci.cabig.caaers.domain.repository.OrganizationRepositoryImpl+.getOrganizationsHavingStudySites*(..))
        ||execution(public * gov.nih.nci.cabig.caaers.domain.repository.OrganizationRepositoryImpl+.getApplicableOrganizationsFromStudySites*(java.lang.String,java.lang.Integer))
        ||execution(public * gov.nih.nci.cabig.caaers.domain.repository.OrganizationRepositoryImpl+.searchOrganization(..))
        ||execution(public * gov.nih.nci.cabig.caaers.domain.repository.StudyRepository+.find(..))
        ||execution(public * gov.nih.nci.cabig.caaers.domain.repository.ResearchStaffRepository+.getResearchStaff(..))
        ||execution(public * gov.nih.nci.cabig.caaers.api.impl.AdverseEventManagementServiceImpl+.create*(..))
        ||execution(public * gov.nih.nci.cabig.caaers.api.impl.AdverseEventManagementServiceImpl+.delete*(..))  
        ||execution(public * gov.nih.nci.cabig.caaers.api.impl.DefaultResearchStaffMigratorService+.saveResearchStaff(..))   
        ||execution(public * gov.nih.nci.cabig.caaers.api.impl.DefaultInvestigatorMigratorService+.saveInvestigator(..))   
                              "/>

        <!-- advisors -->


        <!-- aspects -->
        <!--
              <aop:aspect id="assignDomainObjectOwnershipAspect"
              ref="assignDomainObjectOwnershipBean">
              <aop:after-returning
              pointcut-ref="daoSaveOrUpdatePointcut"
              method="assignOwner"
              returning="domainObject" />
              </aop:aspect>
          -->

        <aop:aspect id="daoSecurityInterceptorAspect" ref="daoSecurityInterceptorAspectBean">
            <aop:around pointcut-ref="daoSaveOrUpdatePointcut" method="advise"/>
        </aop:aspect>
<!--
        <aop:aspect ref="refreshIndexAspect">		
			<aop:pointcut id="executionOfIndexRefreshAfterUpdate"
                    expression="execution(* gov.nih.nci.cabig.caaers.domain.repository.StudyRepository.save(..))
                    	     || execution(* gov.nih.nci.cabig.caaers.domain.repository.StudyRepository.merge(..))
                    		 || execution(* gov.nih.nci.cabig.caaers.dao.ParticipantDao.save(..))
                    		 "/>
            <aop:after pointcut-ref="executionOfIndexRefreshAfterUpdate" method="updateIndexByUserName"/>			
		</aop:aspect>
-->
        <aop:aspect ref="querySecurityFilterAspect">		
			<aop:pointcut id="QuerySecurityFilterAspectPointCut"
                    expression="execution(* gov.nih.nci.cabig.caaers.domain.repository.ajax.ParticipantAjaxableDomainObjectRepository.findParticipants(gov.nih.nci.cabig.caaers.dao.query.ajax.ParticipantAjaxableDomainObjectQuery)) and args(qry)
                    			|| execution(* gov.nih.nci.cabig.caaers.dao.StudyDao.search(gov.nih.nci.cabig.caaers.dao.query.ajax.AbstractAjaxableDomainObjectQuery)) and args(qry)
                    			|| execution(* gov.nih.nci.cabig.caaers.dao.StudyDao.find(gov.nih.nci.cabig.caaers.dao.query.AbstractQuery)) and args(qry)
                    			|| execution(* gov.nih.nci.cabig.caaers.dao.AdverseEventReportingPeriodDao.findAdverseEventReportingPeriods(gov.nih.nci.cabig.caaers.dao.query.AdverseEventReportingPeriodForReviewQuery)) and args(qry)
                    			|| execution(* gov.nih.nci.cabig.caaers.dao.OrganizationDao.get*(gov.nih.nci.cabig.caaers.dao.query.OrganizationQuery)) and args(qry)
	       						|| execution(* gov.nih.nci.cabig.caaers.dao.OrganizationDao.get*(gov.nih.nci.cabig.caaers.dao.query.OrganizationFromStudySiteQuery)) and args(qry)
	       						|| execution(* gov.nih.nci.cabig.caaers.dao.ExpeditedAdverseEventReportDao.get*(gov.nih.nci.cabig.caaers.dao.query.ExpeditedAdverseEventReportQuery)) and args(qry)
                    			"/>
            <aop:before pointcut-ref="QuerySecurityFilterAspectPointCut" method="applyFilter"/>			
		</aop:aspect>

    </aop:config>

    <!--
         <bean id="assignDomainObjectOwnershipBean" class="gov.nih.nci.cabig.caaers.security.CaaersDomainObjectOwnershipAssigner">
         <property name="csmAuthorizationManager" ref="csmUserProvisioningManager"/>
         </bean>
     -->

    <bean id="daoSecurityInterceptorAspectBean" class="gov.nih.nci.security.acegi.csm.aop.SecurityInterceptorAspect">
        <property name="securityInterceptor" ref="daoSecurity"/>
    </bean>


    <bean id="daoSecurityTemplate" abstract="true">
        <property name="authenticationManager"
                  ref="authenticationManager"/>
    </bean>

    <util:map id="joinPointObjectPrivilegeMap"
              map-class="java.util.LinkedHashMap">
		<!-- CAAERS-3565 -->
        <entry key="execution(* save(gov.nih.nci.cabig.caaers.domain.ExpeditedAdverseEventReport))"
               value="gov.nih.nci.cabig.caaers.domain.ExpeditedAdverseEventReport:UPDATE"/>

        <entry key="execution(* save(gov.nih.nci.cabig.caaers.domain.Study))"
               value="gov.nih.nci.cabig.caaers.domain.Study:CREATE"/>

        <entry key="execution(* merge(gov.nih.nci.cabig.caaers.domain.Study))"
               value="gov.nih.nci.cabig.caaers.domain.Study:UPDATE"/>

        <entry key="execution(* save(gov.nih.nci.cabig.caaers.domain.Participant))"
               value="gov.nih.nci.cabig.caaers.domain.Participant:CREATE"/>

        <entry key="execution(* gov.nih.nci.cabig.caaers.dao.StudyDao.updateStudyForServiceUseOnly(gov.nih.nci.cabig.caaers.domain.Study))"
               value="gov.nih.nci.cabig.caaers.domain.Participant:CREATE"/>
               
        <entry key="execution(* gov.nih.nci.cabig.caaers.dao.StudyDao.search*(..))"
               value="gov.nih.nci.cabig.caaers.domain.ExpeditedAdverseEventReport:ACCESS"/>

        <entry key="execution(* gov.nih.nci.cabig.caaers.dao.StudyDao.get*(..))"
               value="gov.nih.nci.cabig.caaers.domain.ExpeditedAdverseEventReport:ACCESS"/>
               
        <entry key="execution(* gov.nih.nci.cabig.caaers.domain.repository.ajax.StudySearchableAjaxableDomainObjectRepository.find*(..))"
               value="gov.nih.nci.cabig.caaers.domain.ExpeditedAdverseEventReport:ACCESS"/>
               
        <entry key="execution(* gov.nih.nci.cabig.caaers.domain.repository.ajax.ParticipantAjaxableDomainObjectRepository.find*(..))"
               value="gov.nih.nci.cabig.caaers.domain.ExpeditedAdverseEventReport:ACCESS"/>

        <entry key="execution(* gov.nih.nci.cabig.caaers.dao.ExpeditedAdverseEventReportDao.search*(..))"
               value="gov.nih.nci.cabig.caaers.domain.ExpeditedAdverseEventReport:ACCESS"/>
 
        <entry key="execution(* gov.nih.nci.cabig.caaers.domain.repository.OrganizationRepositoryImpl+.getOrganizationsHavingStudySites*(..))"
               value="gov.nih.nci.cabig.caaers.domain.Participant:READ"/>
               
        <entry key="execution(* gov.nih.nci.cabig.caaers.domain.repository.OrganizationRepositoryImpl+.getApplicableOrganizationsFromStudySites*(java.lang.String,java.lang.Integer))"
               value="gov.nih.nci.cabig.caaers.domain.Organization:ACCESS"/>
               
        <entry key="execution(* gov.nih.nci.cabig.caaers.domain.repository.OrganizationRepositoryImpl+.searchOrganization(..))"
               value="gov.nih.nci.cabig.caaers.domain.Participant:READ"/>
        <!--                                    
        <entry key="execution(* gov.nih.nci.cabig.caaers.dao.ParticipantDao.search*(..))"
               value="gov.nih.nci.cabig.caaers.domain.Participant:READ"/>  -->             

        <entry key="execution(* gov.nih.nci.cabig.caaers.domain.StudyParticipantAssignment.setParticipant(gov.nih.nci.cabig.caaers.domain.Participant))"
               value="gov.nih.nci.cabig.caaers.domain.ExpeditedAdverseEventReport:ACCESS"/>
               
        <entry key="execution(* gov.nih.nci.cabig.caaers.domain.repository.StudyRepository.find(..))"
               value="gov.nih.nci.cabig.caaers.domain.Participant:READ"/>

        <entry key="execution(* gov.nih.nci.cabig.caaers.domain.repository.ResearchStaffRepository+.getResearchStaff(..))"
               value="gov.nih.nci.cabig.caaers.Admin:ACCESS"/>               
               
        <entry key="execution(* gov.nih.nci.cabig.caaers.api.impl.AdverseEventManagementServiceImpl+.create*(..))"
               value="gov.nih.nci.cabig.caaers.domain.ExpeditedAdverseEventReport:CREATE"/>
               
        <entry key="execution(* gov.nih.nci.cabig.caaers.api.impl.AdverseEventManagementServiceImpl+.delete*(..))"
               value="gov.nih.nci.cabig.caaers.domain.ExpeditedAdverseEventReport:CREATE"/>

        <entry key="execution(* gov.nih.nci.cabig.caaers.api.impl.DefaultResearchStaffMigratorService+.saveResearchStaff(..))"
               value="gov.nih.nci.cabig.caaers.Admin:ACCESS"/>

        <entry key="execution(* gov.nih.nci.cabig.caaers.api.impl.DefaultInvestigatorMigratorService+.saveInvestigator(..))"
               value="gov.nih.nci.cabig.caaers.Admin:ACCESS"/>
                              
    </util:map>

    <bean id="joinPointPrivilegeAndObjectIdGenerator"
          class="gov.nih.nci.security.acegi.csm.authorization.JoinPointPrivilegeAndObjectIdGenerator">
        <property name="objectPrivilegeMap"
                  ref="joinPointObjectPrivilegeMap"/>
    </bean>

    <bean id="daoAuthorizationCheck" autowire="byType"
          class="gov.nih.nci.security.acegi.csm.authorization.DelegatingObjectPrivilegeCSMAuthorizationCheck">
        <property name="csmAuthorizationCheck">
            <bean
                    class="gov.nih.nci.security.acegi.grid.authorization.CSMGridGroupAuthorizationCheck">
                <property name="csmUserProvisioningManager"
                          ref="csmUserProvisioningManager"/>
                <property name="authorizationSwitch" ref="authorizationSwitch"/>
            </bean>
        </property>
        <property name="objectIdGenerator"
                  ref="joinPointPrivilegeAndObjectIdGenerator"/>
        <property name="privilegeGenerator"
                  ref="joinPointPrivilegeAndObjectIdGenerator"/>
    </bean>

    <bean id="daoSecurity" parent="daoSecurityTemplate" class="org.acegisecurity.intercept.method.aspectj.AspectJSecurityInterceptor">
        <property name="objectDefinitionSource">
            <value>
                gov.nih.nci.cabig.caaers.dao.ExpeditedAdverseEventReportDao.*=CSM_AUTHN_CHECK
                gov.nih.nci.cabig.caaers.dao.StudyDao.*=CSM_AUTHN_CHECK
                gov.nih.nci.cabig.caaers.domain.StudyParticipantAssignment.*=CSM_AUTHN_CHECK
                gov.nih.nci.cabig.caaers.domain.repository.ajax.StudySearchableAjaxableDomainObjectRepository.*=CSM_AUTHN_CHECK
                gov.nih.nci.cabig.caaers.domain.repository.ajax.ParticipantAjaxableDomainObjectRepository.*=CSM_AUTHN_CHECK
                gov.nih.nci.cabig.caaers.domain.repository.OrganizationRepositoryImpl.getOrganizationsHavingStudySites=CSM_AUTHN_CHECK
                gov.nih.nci.cabig.caaers.domain.repository.OrganizationRepositoryImpl.getApplicableOrganizationsFromStudySites=CSM_AUTHN_CHECK
                gov.nih.nci.cabig.caaers.domain.repository.OrganizationRepositoryImpl.searchOrganization=CSM_AUTHN_CHECK
                gov.nih.nci.cabig.caaers.domain.repository.StudyRepository.*=CSM_AUTHN_CHECK
                gov.nih.nci.cabig.caaers.api.impl.AdverseEventManagementServiceImpl.create*=CSM_AUTHN_CHECK
                gov.nih.nci.cabig.caaers.api.impl.AdverseEventManagementServiceImpl.delete*=CSM_AUTHN_CHECK 
                gov.nih.nci.cabig.caaers.api.impl.DefaultResearchStaffMigratorService.saveResearchStaff=CSM_AUTHN_CHECK     
                gov.nih.nci.cabig.caaers.api.impl.DefaultInvestigatorMigratorService.saveInvestigator=CSM_AUTHN_CHECK
            </value>
        </property>
        <property name="accessDecisionManager">
            <bean class="org.acegisecurity.vote.AffirmativeBased">
                <property name="allowIfAllAbstainDecisions">
                    <value>false</value>
                </property>
                <property name="decisionVoters">
                    <list>
                    	<bean class="gov.nih.nci.cabig.caaers.security.SystemUserVoter">
                    		<property name="username" value="SYSTEM"/>
							<property name="password" value="ignoreme" />
                    	</bean>
                        <bean class="gov.nih.nci.security.acegi.csm.vote.AuthorizationSwitchVoter">
                            <property name="authorizationSwitch" ref="authorizationSwitch"/>
                            <property name="requiresAuthentication" value="false"/>
                        </bean>
                        <bean class="gov.nih.nci.security.acegi.csm.vote.CSMAuthorizationCheckVoter">
                            <property name="processConfigAttribute"
                                      value="CSM_AUTHN_CHECK"/>
                            <property name="authorizationCheck"
                                      ref="daoAuthorizationCheck"/>
                        </bean>
                    </list>
                </property>
            </bean>
        </property>
        <property name="afterInvocationManager">
            <ref bean="afterInvocationManager"/>
        </property>
    </bean>
    <bean id="afterInvocationManager" class="org.acegisecurity.afterinvocation.AfterInvocationProviderManager">
        <property name="providers">
            <list>
            	<!-- we are restricting all the results in search , why do we need to check once again for a given instance , will clarify with SAURAV when he gets back -  Srini
                <ref local="siteSecurityBasicAuthCheck"/>
                -->
                <ref local="siteSecurityCollectionFilter"/>
            </list>
        </property>
    </bean>


    <bean id="studyParticipantAssignmentAspect"
          class="gov.nih.nci.cabig.caaers.security.StudyParticipantAssignmentAspect"
          factory-method="aspectOf">

        <property name="securityInterceptor"
                  ref="daoSecurity"/>

    </bean>
    <!--> oraganization security beans  start here-->
    <bean id="sitePrivilegeAndObjectIdGenerator"
          class="gov.nih.nci.cabig.caaers.security.SitePrivilegeAndObjectIdGenerator">
        <property name="accessPrivilege" value="ACCESS"/>
        <property name="pathSeperator" value="."/>
    </bean>

    <bean id="siteSecurityCollectionFilter" class="gov.nih.nci.cabig.caaers.accesscontrol.SiteSecurityAfterInvocationCollectionFilteringProvider">
        <property name="processConfigAttribute" value="CSM_AUTHN_CHECK"/>
        <property name="domainObjectSiteSecurityAuhthorizationCheckProvidersMap" ref="domainObjectSiteSecurityAuhthorizationCheckProvidersMap"/>
        <property name="authorizationSwitch" ref="authorizationSwitch"/>
    </bean>

    <bean id="siteSecurityBasicAuthCheck"
          class="gov.nih.nci.cabig.caaers.accesscontrol.SiteSecurityAfterInvocationBasicAuthorizationCheckProvider">
        <property name="processConfigAttribute"
                  value="CSM_AUTHN_CHECK"/>
        <property name="accessPrivilege" ref="ACCESS_PRIVILEGE"/>
        <property name="domainObjectSiteSecurityAuhthorizationCheckProvidersMap"
                  ref="domainObjectSiteSecurityAuhthorizationCheckProvidersMap"/>
        <property name="authorizationSwitch" ref="authorizationSwitch"/>
    </bean>
    <bean id="ACCESS_PRIVILEGE" class="java.lang.String">
        <constructor-arg value="ACCESS"/>
    </bean>


    <util:map id="domainObjectSiteSecurityAuhthorizationCheckProvidersMap"
              map-class="java.util.LinkedHashMap">
     </util:map>

    <!--> oraganization security beans end here  -->


    <bean id="csmGroupAuthorizationCheck"
          class="gov.nih.nci.security.acegi.csm.authorization.CSMGroupAuthorizationCheck">
        <property name="csmUserProvisioningManager"
                  ref="csmUserProvisioningManager"/>
        <property name="authorizationSwitch" ref="authorizationSwitch"/>
    </bean>

	<!-- Run as authentication Populator -->
	<bean id="runAsAuthenticationPopulator"
		class="gov.nih.nci.cabig.caaers.security.RunAsAuthenticationPopulator">
		<property name="username" value="SYSTEM" />
		<property name="password" value="ignoreme" />
		<property name="authorities">
			<list>
				<value>ROLE_caaers_super_user</value>
				<value>ROLE_caaers_admin</value>
				<value>ROLE_caaers_grid_user</value>
			</list>
		</property>
	</bean>
	
	<bean id="runAsAutenticationProviderInterceptor" class="gov.nih.nci.cabig.caaers.security.RunAsAuthenticationPopulatorIncerceptor">
		<property name="runAsAuthenticationPopulator" ref="runAsAuthenticationPopulator" />
	</bean>	

	<bean id="gridAutenticationInterceptor" class="gov.nih.nci.cabig.caaers.security.GridAuthenticationInterceptor">
		<property name="csmUserDetailsService" ref="csmUserDetailsService" />
	</bean>
		
	<!-- ==== Authentication Related Stuff ================ -->
	
    <bean id="csmLockoutManager" class="gov.nih.nci.cabig.caaers.security.CaaersCSMLockoutManagerFactoryBean"  /> 
    
    <bean id="csmAuthenticationManager" class="gov.nih.nci.security.SecurityServiceProvider" factory-method="getAuthenticationManager" depends-on="csmLockoutManager">
        <constructor-arg ref="csmApplicationContextName"/>
    </bean>   
		
	<bean id="localAuthenticationProvider" class="gov.nih.nci.cabig.caaers.security.CaaersCSMAuthenticationProvider" lazy-init="true">
		<property name="csmAuthenticationManager" ref="csmAuthenticationManager" />
		<property name="userDetailsService" ref="csmUserDetailsService" />
		<property name="passwordPolicyService" ref="passwordPolicyService" />
		<property name="userDao" ref="userDao" />
		<property name="userCache" ref="userCache"/>
	</bean>
	
	<bean id="csmUserDetailsService" class="gov.nih.nci.cabig.caaers.security.CaaersCSMUserDetailsService" lazy-init="true">
		<property name="csmUserProvisioningManager" ref="csmUserProvisioningManager"/>
	</bean>
	
	
	<bean id="userCache" class="org.acegisecurity.providers.dao.cache.EhCacheBasedUserCache">
		<property name="cache">
			<bean class="org.springframework.cache.ehcache.EhCacheFactoryBean">
				<property name="cacheManager" ref="cacheManager" />
				<property name="cacheName" value="userCache"/>
			</bean>
		</property>
	</bean>
	<!-- Cached Manager -->
	 <bean id="cacheManager" class="org.springframework.cache.ehcache.EhCacheManagerFactoryBean" lazy-init="true"/>
	 
	<bean id="fetcherUtils" class="gov.nih.nci.cabig.caaers.utils.FetcherUtils"/>	

	 <bean id="refreshIndexAspect" class="gov.nih.nci.cabig.caaers.accesscontrol.aspects.RefreshIndexAspect">
		  <property name="filteredDataLoader" ref="filteredDataLoader"/>
     </bean>      	
	 <bean id="filteredDataLoaderTarget" class="gov.nih.nci.cabig.caaers.accesscontrol.dataproviders.FilteredDataLoader">
		  <property name="idFetchers">
             <list>
                <ref bean="participantIdFetcher"/>
                <ref bean="studyIdFetcher"/>
                <ref bean="adverseEventIdFetcher"/>
                <ref bean="expeditedAdverseEventReportIdFetcher"/>
                <ref bean="organizationIdFetcher"/>
                <ref bean="reportingPeriodIdFetcher"/>                
            </list>
         </property> 
         <property name="idFetcherIndexDaoMap" ref="idFetcherIndexDaoMap"/>
     </bean> 
     <util:map id="idFetcherIndexDaoMap"
              map-class="java.util.LinkedHashMap">
        <entry key-ref="participantIdFetcher"
               value-ref="participantIndexDao"/>
        <entry key-ref="studyIdFetcher"
               value-ref="studyIndexDao"/>                 
        <entry key-ref="adverseEventIdFetcher"
               value-ref="adverseEventIndexDao"/>
        <entry key-ref="expeditedAdverseEventReportIdFetcher"
               value-ref="expeditedAdverseEventReportIndexDao"/>  
        <entry key-ref="organizationIdFetcher"
               value-ref="organizationIndexDao"/>
        <entry key-ref="reportingPeriodIdFetcher"
               value-ref="reportingPeriodIndexDao"/>                 
    </util:map>
      
  <bean id="filteredDataLoader" class="org.springframework.aop.framework.ProxyFactoryBean"> 
		<property name="proxyTargetClass"><value>true</value></property>
		<property name="target"><ref local="filteredDataLoaderTarget"/></property> 
		<property name="interceptorNames"> 
			<list> 
				<value>runAsAutenticationProviderInterceptor</value>
				<value>auditInfoPopulatorInterceptor</value>
				<value>hibernateInterceptor</value> 
			</list> 
		</property> 
	</bean>
	    
    
    <bean id="abstractIdFetcher" abstract="true">
        <property name="hibernateTemplate" ref="hibernateTemplate" />
        <property name="csmUserRepository" ref="csmUserRepository" />
        <property name="fetcherUtils" ref="fetcherUtils" />
    </bean>
    
    <!-- PLUGGABLE ID FETCHER IMPLEMENTATIONS -->
	<bean id="participantIdFetcher" class="gov.nih.nci.cabig.caaers.accesscontrol.query.impl.CaaersParticipantIdFetcherImpl" parent ="abstractIdFetcher"/>
    <bean id="studyIdFetcher" class="gov.nih.nci.cabig.caaers.accesscontrol.query.impl.CaaersStudyIdFetcherImpl" parent="abstractIdFetcher"/>
    <bean id="adverseEventIdFetcher" class="gov.nih.nci.cabig.caaers.accesscontrol.query.impl.CaaersAdverseEventIdFetcherImpl" parent="abstractIdFetcher"/>
    <bean id="expeditedAdverseEventReportIdFetcher" class="gov.nih.nci.cabig.caaers.accesscontrol.query.impl.CaaersExpeditedAdverseEventReportIdFetcherImpl" parent="abstractIdFetcher"/>
    <bean id="organizationIdFetcher" class="gov.nih.nci.cabig.caaers.accesscontrol.query.impl.CaaersOrganizationIdFetcherImpl" parent="abstractIdFetcher"/>
    <bean id="reportingPeriodIdFetcher" class="gov.nih.nci.cabig.caaers.accesscontrol.query.impl.CaaersReportingPeriodIdFetcherImpl" parent="abstractIdFetcher"/>


    <!-- Pluggable Query Filterer implementation -->

    <bean id="querySecurityFilterAspect"   class="gov.nih.nci.cabig.caaers.accesscontrol.aspects.QuerySecurityFilterAspect" >
    	<property name="querySecurityFilterDispatcher" ref="querySecurityFilterDispatcher"/>
    </bean>
    
    <bean id="querySecurityFilterDispatcher" class="gov.nih.nci.cabig.caaers.accesscontrol.filter.QuerySecurityFiltererDispatcher">
          <property name="filtererMap">
              <map>
                  
                  <entry key="gov.nih.nci.cabig.caaers.dao.query.StudyQuery"   value-ref="studyQuerySecurityFilterer"/>
                  <entry key="gov.nih.nci.cabig.caaers.dao.query.ajax.StudySearchableAjaxableDomainObjectQuery"   value-ref="studyQuerySecurityFilterer"/>
                  <entry key="gov.nih.nci.cabig.caaers.dao.query.StudyHavingStudySiteQuery"   value-ref="studyQuerySecurityFilterer"/>
                  <entry key="gov.nih.nci.cabig.caaers.dao.query.ParticipantQuery"   value-ref="participantQuerySecurityFilterer" />
                  <entry key="gov.nih.nci.cabig.caaers.dao.query.ajax.ParticipantAjaxableDomainObjectQuery" value-ref="participantAjaxableQuerySecurityFilterer" />
                  <entry key="gov.nih.nci.cabig.caaers.dao.query.AdverseEventReportingPeriodForReviewQuery" value-ref="adverseEventReportingPeriodForReviewQuerySecurityFilterer" />
              	  <entry key="gov.nih.nci.cabig.caaers.dao.query.OrganizationQuery" value-ref="organizationQuerySecurityFilterer" />
              	  <entry key="gov.nih.nci.cabig.caaers.dao.query.OrganizationFromStudySiteQuery" value-ref="organizationQuerySecurityFilterer" />
              	  <entry key="gov.nih.nci.cabig.caaers.dao.query.ExpeditedAdverseEventReportQuery" value-ref="reportQuerySecurityFilterer" />

              </map>
          </property>
    </bean>

    <bean id="studyQuerySecurityFilterer" class="gov.nih.nci.cabig.caaers.accesscontrol.filter.query.QuerySecurityFilterer" p:entityAssociation="study" p:entityName="Study" p:indexName="StudyIndex" p:indexAlias="sIndx" />
    <bean id="participantQuerySecurityFilterer" class="gov.nih.nci.cabig.caaers.accesscontrol.filter.query.QuerySecurityFilterer" p:entityAssociation="p" p:entityName="Participant" p:indexName="ParticipantIndex" p:indexAlias="pIndx"/>
    <bean id="participantAjaxableQuerySecurityFilterer" class="gov.nih.nci.cabig.caaers.accesscontrol.filter.query.QuerySecurityFilterer" p:entityAssociation="participant" p:entityName="Participant" p:indexName="ParticipantIndex" p:indexAlias="pIndx"/>
    <bean id="adverseEventReportingPeriodForReviewQuerySecurityFilterer" class="gov.nih.nci.cabig.caaers.accesscontrol.filter.query.QuerySecurityFilterer" p:entityAssociation="reportingPeriod" p:entityName="AdverseEventReportingPeriod" p:indexName="ReportingPeriodIndex" p:indexAlias="rpIndx"/>
    <bean id="organizationQuerySecurityFilterer" class="gov.nih.nci.cabig.caaers.accesscontrol.filter.query.QuerySecurityFilterer" p:entityAssociation="organization" p:entityName="Organization" p:indexName="OrganizationIndex" p:indexAlias="orgIndx" p:rolesNotNeedFiltering="caaers_study_cd,caaers_site_cd"/>
    <bean id="reportQuerySecurityFilterer" class="gov.nih.nci.cabig.caaers.accesscontrol.filter.query.QuerySecurityFilterer" p:entityAssociation="expeditedAdverseEventReport" p:entityName="ExpeditedAdverseEventReport" p:indexName="ExpeditedAdverseEventReportIndex" p:indexAlias="reportIndx" />
</beans>
