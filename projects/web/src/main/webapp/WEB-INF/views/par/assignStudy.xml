<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="
		http://www.springframework.org/schema/webflow
		http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">

    <var name="command" class="gov.nih.nci.cabig.caaers.web.participant.StudySubjectAssignmentCommand"></var>
    <var name="studySite" class="gov.nih.nci.cabig.caaers.domain.StudySite"></var>

    <view-state id="assignStudy" view="par/assignStudy">
        <transition on="chooseStudy" to="chooseStudy">
        </transition>

        <transition on="chooseParticipant" to="chooseParticipant">
        </transition>

        <transition on="medicalHistory" to="medicalHistory">
        </transition>

        <transition on="save" to="finalSave">

        </transition>
    </view-state>


    <view-state id="medicalHistory" view="par/medicalHistory" model="command">
        <transition on="addPriorTherapy" to="addPriorTherapy">
            <evaluate expression="command.newPriorTherapy()" result="viewScope.priorTherapy"
                      result-type="gov.nih.nci.cabig.caaers.domain.StudyParticipantPriorTherapy"></evaluate>

        </transition>

        <transition on="confirm" to="assignStudy"/>

        <transition on="cancel" to="assignStudy" bind="false">
        </transition>


    </view-state>


    <view-state id="addPriorTherapy" view="par/addPriorTherapy" model="priorTherapy" popup="true">
        <on-entry>
            <evaluate expression="priorTherapyFieldGroup.referenceData(priorTherapy)" result="flowScope.fieldGroups"
                      result-type="java.util.Map"></evaluate>

        </on-entry>

        <transition on="save" to="medicalHistory">
            <evaluate expression="command.addPriorTherapy(priorTherapy,messageContext)"></evaluate>

        </transition>

    </view-state>


    <view-state id="chooseStudy" view="par/chooseStudy" model="command" popup="true">
        <transition on="search">
            <!--<evaluate expression="command.validate(messageContext)"></evaluate>-->

            <evaluate expression="studyRepository.search(command.studyType,command.studyText)"
                      result="viewScope.studies" result-type="java.util.List"></evaluate>

        </transition>

        <transition on="confirm" to="assignStudy">
            <evaluate expression="studySiteDao.findByStudyAndOrganization(command.studyId,command.siteId)"
                      result="studySite"
                      result-type="gov.nih.nci.cabig.caaers.domain.StudySite"></evaluate>

        </transition>

        <transition on="cancel" to="assignStudy" bind="false">
        </transition>


    </view-state>


    <view-state id="chooseParticipant" view="par/chooseParticipant" model="command">
        <transition on="search">


            <evaluate
                    expression="participantRepository.search(command.participantType,command.participantText,studySite)"
                    result="flowScope.participants" result-type="java.util.List"></evaluate>

        </transition>

        <transition on="confirm" to="assignStudy">
            <evaluate expression="participantDao.getById(command.participantId)"
                      result="flowScope.participant"
                      result-type="gov.nih.nci.cabig.caaers.domain.Participant"></evaluate>

        </transition>

        <transition on="cancel" to="assignStudy" bind="false">
        </transition>


    </view-state>

    <!--<view-state id="updateDetails" view="par/updateDetails" model="participant">-->
    <!--<on-entry>-->
    <!--<evaluate expression="createParticipantFieldGroup.referenceData(participant)"-->
    <!--result="flowScope.fieldGroups" result-type="java.util.Map"></evaluate>-->
    <!--</on-entry>-->
    <!--<transition on="save" to="finalSave">-->
    <!--<evaluate expression="participantDao.save(participant)"></evaluate>-->
    <!--<evaluate expression="participantValidator.validateBasicDetails(participant)"></evaluate>-->
    <!--</transition>-->
    <!--</view-state>-->


    <end-state id="finalSave" commit="true">
        <output name="participantId" value="1"></output>
    </end-state>

    <!--<view-state id="modifySearchForm" view="searchForm" model="accountSearchCriteria" popup="true">-->
    <!--<on-entry>-->
    <!--<render fragments="body"/>-->
    <!--</on-entry>-->
    <!--<transition on="search" to="index">-->
    <!--<evaluate expression="accountSearchCriteria.resetPage()"/>-->
    <!--</transition>-->
    <!--</view-state>-->

    <!--<view-state id="index">-->
    <!--<on-render>-->
    <!--<evaluate result="viewScope.accounts"-->
    <!--expression="accountRepository.searchByAccountNumber(accountSearchCriteria)"/>-->
    <!--</on-render>-->
    <!--<transition on="next">-->
    <!--<evaluate expression="accountSearchCriteria.nextPage()"/>-->
    <!--<render fragments="body"/>-->
    <!--</transition>-->
    <!--<transition on="previous">-->
    <!--<evaluate expression="accountSearchCriteria.previousPage()"/>-->
    <!--<render fragments="body"/>-->
    <!--</transition>-->
    <!--<transition on="show" to="show">-->
    <!--<set name="flowScope.accountNumber" value="requestParameters.accountNumber"/>-->
    <!--</transition>-->
    <!--<transition on="modifySearch" to="modifySearchForm"/>-->
    <!--</view-state>-->

    <!--<view-state id="show">-->
    <!--<on-render>-->
    <!--<evaluate result="viewScope.account"-->
    <!--expression="accountRepository.findByAccountNumber(accountNumber)"/>-->
    <!--</on-render>-->
    <!--<transition on="searchResults" to="index"/>-->
    <!--<transition on="edit" to="editAccount"/>-->
    <!--</view-state>-->

    <!--<view-state id="editAccount"-->
    <!--view="externalRedirect:servletRelative:/accounts/editAccount?accountNumber=${accountNumber}"/>-->
</flow>
